---
title: "18_MultinicheNet"
author: "Jiating Wang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 12, 
  fig.height = 9,  
  fig.align = "center"  
)
```

## 1. Load Library and Data

```{r}
rm(list = ls())
gc()
library(patchwork)
library(tidyverse)
library(patchwork)
library(SingleCellExperiment)
library(dplyr)
library(ggplot2)
library(multinichenetr)
library(Seurat)
library(nichenetr)
library(Seurat)
library(qs)
library(future)
options(future.globals.maxSize = 1000 * 1024^2)
```

```{r}
sce <- qread("~/OneDrive_4_2025-3-8/data/ctb_scobj_v4.qs")
sce$disease <- factor(sce$disease, levels = c("Normal","CTB_BL","CTB_T"))
sce$donor <- factor(sce$donor, levels = c("N1","N2","N3","N4","N5","N6",
                                          "CTB1","CTB2","CTB3","CTB4",
                                          "CTB5","CTB6","CTB7","CTB8","CTB9",
                                          "CTB10","CTB11","CTB12"))
sce$orig.ident2 <- factor(sce$orig.ident2, levels = c("N1","N2","N3","N4","N5","N6",
                                                      "CTB1_BL","CTB2_BL","CTB3_BL","CTB4_BL",
                                                      "CTB5_BL","CTB6_BL","CTB7_BL","CTB8_BL","CTB9_BL",
                                                      "CTB10_BL","CTB11_BL","CTB12_BL",
                                                      "CTB1_T","CTB2_T","CTB3_T","CTB5_T","CTB7_T",
                                                      "CTB8_T"))
dput(levels(sce$subtype))
sce$subtype <- factor(sce$subtype, levels = c("Basal KC", "Inflammatory KC",
                                              "Proliferating KC", "Spinous KC", 
                                              "Granular KC", "Hair follicle", 
                                              "Sweet Gland", "Schwann Cell", 
                                              "Melanocyte", "CCL19+ FB", "APCDD1+ FB",
                                              "PI16+ FB", "POSTN+ FB", 
                                              "TNN+ FB", "RAMP1+ FB", "Arterial EC",
                                              "Capillary EC", "Venular EC1", 
                                              "Venular EC2", "Lymphatic Endothelial",
                                              "Smooth muscle", "Mast cell", 
                                              "Langerhans", "cDC1", "cDC2A", "cDC2B",
                                              "pDC", "M1-like Mac", 
                                              "M2-like Mac", "SPP1 Mac", "TREM2 Mac",
                                              "CD8T", "Treg", "CD4 Na誰ve", 
                                              "Th17", "CD8T/NK", "Th17/Treg", "NK",
                                              "na誰ve B", "activated B", 
                                              "memory B", "Plasma"))
Idents(sce) <- "subtype"
table(Idents(sce))
sce <- RenameIdents(sce, 
                    "CD8T" = "CD8T",
                    "Treg" = "Treg",
                    "Th17" = "Th17",
                    "NK" = "NK",
                    "CD4 Na誰ve" = "CD4-Naive",
                    "CD8T/NK" = "CD8T-NK",
                    "Th17/Treg" = "Th17-Treg",
                    "na誰ve B" = "Naive B")
sce$celltype <- Idents(sce)
sce$celltype <- factor(sce$celltype, levels = c("Basal KC", "Inflammatory KC",
                                                "Proliferating KC", "Spinous KC", 
                                                "Granular KC", "Hair follicle", 
                                                "Sweet Gland", "Schwann Cell", 
                                                "Melanocyte", "CCL19+ FB", "APCDD1+ FB",
                                                "PI16+ FB", "POSTN+ FB", 
                                                "TNN+ FB", "RAMP1+ FB", "Arterial EC",
                                                "Capillary EC", "Venular EC1", 
                                                "Venular EC2", "Lymphatic Endothelial",
                                                "Smooth muscle", "Mast cell", 
                                                "Langerhans", "cDC1", "cDC2A", "cDC2B",
                                                "pDC", "M1-like Mac", 
                                                "M2-like Mac", "SPP1 Mac", "TREM2 Mac",
                                                "CD8T", "Treg", "CD4-Naive", 
                                                "Th17", "CD8T-NK", "Th17-Treg", "NK",
                                                "Naive B", "activated B", 
                                                "memory B", "Plasma"))
dput(levels(sce$celltype))
```

```{r}
Idents(sce) <- "disease"
sce <- subset(sce,disease %in% c("CTB_BL","CTB_T"))
Idents(sce) <- "disease"
sce$disease <- factor(sce$disease, levels = c("CTB_BL","CTB_T"))
sce$orig.ident2 <- factor(sce$orig.ident2, levels = c("CTB1_BL","CTB2_BL","CTB3_BL","CTB4_BL",
                                                      "CTB5_BL","CTB6_BL","CTB7_BL","CTB8_BL","CTB9_BL",
                                                      "CTB10_BL","CTB11_BL","CTB12_BL",
                                                      "CTB1_T","CTB2_T","CTB3_T","CTB5_T","CTB7_T",
                                                      "CTB8_T"))
table(sce$disease)
```

## **2. Load NicheNet's ligand-receptor network and ligand-target matrix**

```{r}
#lr
lr_network_all = readRDS('~/OneDrive_4_2025-3-8/multinechenetr-human-network/lr_network_human_allInfo_30112033.rds') %>% 
  mutate(ligand = convert_alias_to_symbols(ligand, organism = "human"), 
         receptor = convert_alias_to_symbols(receptor, organism = "human"))

lr_network_all = lr_network_all  %>% mutate(ligand = make.names(ligand), receptor = make.names(receptor))
lr_network = lr_network_all %>% distinct(ligand, receptor)

#weight matrix
# target genes in rows, ligands in columns
ligand_target_matrix = readRDS('~/OneDrive_4_2025-3-8/multinechenetr-human-network/ligand_target_matrix_nsga2r_final.rds')
colnames(ligand_target_matrix) = colnames(ligand_target_matrix) %>% convert_alias_to_symbols(organism = "human") %>% make.names()
rownames(ligand_target_matrix) = rownames(ligand_target_matrix) %>% convert_alias_to_symbols(organism = "human") %>% make.names()

lr_network = lr_network %>% filter(ligand %in% colnames(ligand_target_matrix))
ligand_target_matrix = ligand_target_matrix[, lr_network$ligand %>% unique()]
```

## **3. Convert to SingleCellExperiment Object**

```{r}
sce = Seurat::as.SingleCellExperiment(sce, assay = "RNA")
sce = alias_to_symbol_SCE(sce, "human") %>% makenames_SCE()

SummarizedExperiment::colData(sce)$orig.ident2 = SummarizedExperiment::colData(sce)$orig.ident2 %>% make.names()
SummarizedExperiment::colData(sce)$disease = SummarizedExperiment::colData(sce)$disease %>% make.names()
SummarizedExperiment::colData(sce)$celltype = SummarizedExperiment::colData(sce)$celltype %>% make.names()
SummarizedExperiment::colData(sce)$orig.ident2 <- factor(SummarizedExperiment::colData(sce)$orig.ident2,
                                                         levels = c("CTB1_BL","CTB2_BL","CTB3_BL","CTB4_BL",
                                                                    "CTB5_BL","CTB6_BL","CTB7_BL","CTB8_BL","CTB9_BL",
                                                                    "CTB10_BL","CTB11_BL","CTB12_BL",
                                                                    "CTB1_T","CTB2_T","CTB3_T","CTB5_T","CTB7_T",
                                                                    "CTB8_T"))
SummarizedExperiment::colData(sce)$disease <- factor(SummarizedExperiment::colData(sce)$disease,
                                                     levels = c("CTB_BL","CTB_T"))
names(table(SummarizedExperiment::colData(sce)$celltype))
original_order <- c("Basal KC", "Inflammatory KC", "Proliferating KC", "Spinous KC", 
                    "Granular KC", "Hair follicle", "Sweet Gland", "Schwann Cell", 
                    "Melanocyte", "CCL19+ FB", "APCDD1+ FB", "PI16+ FB", "POSTN+ FB", 
                    "TNN+ FB", "RAMP1+ FB", "Arterial EC", "Capillary EC", "Venular EC1", 
                    "Venular EC2", "Lymphatic Endothelial", "Smooth muscle", "Mast cell", 
                    "Langerhans", "cDC1", "cDC2A", "cDC2B", "pDC", "M1-like Mac", 
                    "M2-like Mac", "SPP1 Mac", "TREM2 Mac", "CD8T", "Treg", "CD4-Naive", 
                    "Th17", "CD8T-NK", "Th17-Treg", "NK", "Naive B", "activated B", 
                    "memory B", "Plasma")
current_names_order <- make.names(original_order)
sce$celltype <- factor(sce$celltype, levels = current_names_order)
SummarizedExperiment::colData(sce)$celltype <- factor(SummarizedExperiment::colData(sce)$celltype,
                                                      levels = current_names_order)
levels(sce$celltype)
```

## **4. Prepare the settings of the MultiNicheNet cell-cell communication analysis**

### **4.1 Define in which metadata columns we can find the group, sample and cell type IDs**

```{r}
sample_id = "orig.ident2"
group_id = "disease"
celltype_id = "celltype"
covariates = NA
batches = NA
```

### **4.2 Define the contrasts of interest**

```{r}
contrasts_oi = c("'CTB_BL-CTB_T','CTB_T-CTB_BL'")
contrast_tbl = tibble(contrast = c('CTB_BL-CTB_T','CTB_T-CTB_BL'), group = c("CTB_BL","CTB_T"))
```

### 4.3 Define the sender and receiver cell types of interest

```{r}
# senders_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
# receivers_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()

senders_oi = droplevels.factor(factor(setdiff(current_names_order, "RAMP1..FB")))
receivers_oi = droplevels.factor(factor(setdiff(current_names_order, "RAMP1..FB")))
sce = sce[, SummarizedExperiment::colData(sce)[,celltype_id] %in% c(senders_oi, receivers_oi)]

conditions_keep = c("CTB_BL","CTB_T")
sce = sce[, SummarizedExperiment::colData(sce)[,group_id] %in% conditions_keep]
```

# **5. Running the MultiNicheNet core analysis**

### 5.1 **Cell-type filtering: determine which cell types are sufficiently present**

```{r}
min_cells = 10

abundance_info = get_abundance_info(
  sce = sce,
  sample_id = sample_id, 
  group_id = group_id, 
  celltype_id = celltype_id,
  min_cells = 10,
  senders_oi = senders_oi, 
  receivers_oi = receivers_oi,
  batches = batches)
```

### 5.2 **Interpretation of cell type abundance information**

```{r}
abundance_info$abund_plot_sample
```

### 5.3 **Gene filtering: determine which genes are sufficiently expressed in each present cell type**

```{r}
fraction_cutoff = 0.05
min_sample_prop = 0.5

frq_list = get_frac_exprs(
  sce = sce, 
  sample_id = sample_id, celltype_id =  celltype_id, group_id = group_id, 
  batches = batches, 
  min_cells = min_cells, 
  fraction_cutoff = fraction_cutoff, 
  min_sample_prop = min_sample_prop)
```

```{r}
genes_oi = frq_list$expressed_df %>% 
  filter(expressed == TRUE) %>% 
  pull(gene) %>% 
  unique() 
sce = sce[genes_oi, ]
```

### 5.4 **Pseudobulk expression calculation: determine and normalize per-sample pseudobulk expression levels for each expressed gene in each present cell type**

```{r}
abundance_expression_info = process_abundance_expression_info(
  sce = sce, 
  sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, 
  min_cells = min_cells, 
  senders_oi = senders_oi, 
  receivers_oi = receivers_oi, 
  lr_network = lr_network, 
  batches = batches, 
  frq_list = frq_list, 
  abundance_info = abundance_info)
```

Normalized pseudobulk expression values per gene/celltype/sample can be inspected by:

```{r}
abundance_expression_info$celltype_info$pb_df %>% head()
```

An average of these sample-level expression values per condition/group can be inspected by:

```{r}
abundance_expression_info$celltype_info$pb_df_group %>% head()
```

### **5.5 Differential expression (DE) analysis: determine which genes are differentially expressed**

```{r}
DE_info = get_DE_info(
  sce = sce, 
  sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, 
  batches = batches, covariates = covariates, 
  contrasts_oi = contrasts_oi, 
  min_cells = min_cells, 
  expressed_df = frq_list$expressed_df)
```

Check DE results

```{r}
celltype_de = DE_info$celltype_de$de_output_tidy
```

### **5.6 Combine DE information for ligand-senders and receptors-receivers**

```{r}
sender_receiver_de = multinichenetr::combine_sender_receiver_de(
  sender_de = celltype_de,
  receiver_de = celltype_de,
  senders_oi = senders_oi,
  receivers_oi = receivers_oi,
  lr_network = lr_network)
```

### 5.7 **Ligand activity prediction: use the DE analysis output to predict the activity of ligands in receiver cell types and infer their potential target genes**

#### 5.7.1 **Assess geneset_oi-vs-background ratios for different DE output thresholds prior to the NicheNet ligand activity analysis**

```{r}
logFC_threshold = 0.50
p_val_threshold = 0.05
p_val_adj = FALSE 
geneset_assessment = contrast_tbl$contrast %>% 
  lapply(process_geneset_data, 
         celltype_de, logFC_threshold, p_val_adj, p_val_threshold) %>% 
  bind_rows() 
geneset_assessment
```

#### 5.7.2 **Perform the ligand activity analysis and ligand-target inference**

```{r}
top_n_target = 250
verbose = TRUE
cores_system = 8
n.cores = min(cores_system, celltype_de$cluster_id %>% unique() %>% length()) 

ligand_activities_targets_DEgenes = suppressMessages(suppressWarnings(
  get_ligand_activities_targets_DEgenes(
    receiver_de = celltype_de,
    receivers_oi = intersect(receivers_oi, celltype_de$cluster_id %>% unique()),
    ligand_target_matrix = ligand_target_matrix,
    logFC_threshold = logFC_threshold,
    p_val_threshold = p_val_threshold,
    p_val_adj = p_val_adj,
    top_n_target = top_n_target,
    verbose = verbose, 
    n.cores = n.cores
  )
))
```

You can check the output of the ligand activity and ligand-target inference here:

```{r}
ligand_activities_targets_DEgenes$ligand_activities %>% head(20)
```

### 5.8 **Prioritization: rank cell-cell communication patterns through multi-criteria prioritization**

```{r}
ligand_activity_down = FALSE

sender_receiver_tbl = sender_receiver_de %>% distinct(sender, receiver)

metadata_combined = SummarizedExperiment::colData(sce) %>% tibble::as_tibble()

if(!is.na(batches)){
  grouping_tbl = metadata_combined[,c(sample_id, group_id, batches)] %>% 
    tibble::as_tibble() %>% distinct()
  colnames(grouping_tbl) = c("sample","group",batches)
} else {
  grouping_tbl = metadata_combined[,c(sample_id, group_id)] %>% 
    tibble::as_tibble() %>% distinct()
  colnames(grouping_tbl) = c("sample","group")
}

prioritization_tables = suppressMessages(multinichenetr::generate_prioritization_tables(
    sender_receiver_info = abundance_expression_info$sender_receiver_info,
    sender_receiver_de = sender_receiver_de,
    ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
    contrast_tbl = contrast_tbl,
    sender_receiver_tbl = sender_receiver_tbl,
    grouping_tbl = grouping_tbl,
    scenario = "regular", # all prioritization criteria will be weighted equally
    fraction_cutoff = fraction_cutoff, 
    abundance_data_receiver = abundance_expression_info$abundance_data_receiver,
    abundance_data_sender = abundance_expression_info$abundance_data_sender,
    ligand_activity_down = ligand_activity_down
  ))
```

```{r}
prioritization_tables$group_prioritization_tbl %>% head(20)
```

### 5.9 **Calculate the across-samples expression correlation between ligand-receptor pairs and target genes**

```{r}
lr_target_prior_cor = lr_target_prior_cor_inference(
  receivers_oi = prioritization_tables$group_prioritization_tbl$receiver %>% unique(), 
  abundance_expression_info = abundance_expression_info, 
  celltype_de = celltype_de, 
  grouping_tbl = grouping_tbl, 
  prioritization_tables = prioritization_tables, 
  ligand_target_matrix = ligand_target_matrix, 
  logFC_threshold = logFC_threshold, 
  p_val_threshold = p_val_threshold, 
  p_val_adj = p_val_adj
  )
```

### 5.10 **Save all the output of MultiNicheNet**

```{r}
path = "~/OneDrive_4_2025-3-8/data/"

multinichenet_output = list(
    celltype_info = abundance_expression_info$celltype_info,
    celltype_de = celltype_de,
    sender_receiver_info = abundance_expression_info$sender_receiver_info,
    sender_receiver_de =  sender_receiver_de,
    ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
    prioritization_tables = prioritization_tables,
    grouping_tbl = grouping_tbl,
    lr_target_prior_cor = lr_target_prior_cor
  ) 
multinichenet_output = make_lite_output(multinichenet_output)

save = TRUE
if(save == TRUE){
  saveRDS(multinichenet_output, paste0(path, "multinichenet_output_new.rds"))
}
```

# **6. Interpreting the MultiNicheNet analysis output**

### 6.1 **Visualization of differential cell-cell interactions**

```{r}
multinichenet_output <- readRDS('~/OneDrive_4_2025-3-8/data/multinichenet_output_new.rds')
```

```{r}
senders_receivers = c("Basal.KC", "Inflammatory.KC", "Proliferating.KC", "Spinous.KC", 
"Granular.KC", "Hair.follicle", "Sweet.Gland", "Schwann.Cell", 
"Melanocyte", "CCL19..FB", "APCDD1..FB", "PI16..FB", "POSTN..FB", 
"TNN..FB", "Arterial.EC", "Capillary.EC", "Venular.EC1", "Venular.EC2", 
"Lymphatic.Endothelial", "Smooth.muscle", "Mast.cell", "Langerhans", 
"cDC1", "cDC2A", "cDC2B", "pDC", "M1.like.Mac", "M2.like.Mac", 
"SPP1.Mac", "TREM2.Mac", "CD8T", "Treg", "CD4.Naive", "Th17", 
"CD8T.NK", "Th17.Treg", "NK", "Naive.B", "activated.B", "memory.B", 
"Plasma") 
```

#### 6.1.1 **Summarizing ChordDiagram circos plots**

```{r}
prioritized_tbl_oi_all = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 200, 
  rank_per_group = T
  )
```

```{r fig.width=12, fig.height=15}
prioritized_tbl_oi = 
  multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  filter(id %in% prioritized_tbl_oi_all$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% 
  left_join(prioritized_tbl_oi_all)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

# senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique()) %>%
#   sort()
senders_receivers = senders_receivers 

subtype_cols= c("#E6194B", "#3CB44B", "#4363D8", "#FFE119", "#F58231", "#911EB4", "#46F0F0", "#F032E6", "#BCBD22", "#008080", "#E6BEFF", "#9A6324", "#FFFAC8", "#AAFFC3", "#FFD8B1",
             "#000075", "#A9A9A9", "#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD", "#8C564B",
             "#E377C2", "#7F7F7F", "#17BECF", "#FF9898", "#C5B0D5", "#C49C94", "#F7B6D2", "#C7C7C7",
             "#DBDB8D", "#9EDAE5", "#FFBB78", "#98DF8A", "#AEC7E8", "#FF9E9E", "#B5D0D9", "#D4B9D6",
             "#FDB462", "#80B1D3")
# colors_sender = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% 
#   magrittr::set_names(senders_receivers)
# colors_receiver = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% 
#   magrittr::set_names(senders_receivers)
colors_sender = subtype_cols%>% 
   magrittr::set_names(senders_receivers)
colors_receiver = subtype_cols%>% 
   magrittr::set_names(senders_receivers)
```

```{r fig.width=12, fig.height=15}
# par(mfrow = c(1,2), xpd=T)
prioritized_tbl_bl <- prioritized_tbl_oi %>%
  filter(group == 'CTB_BL' & prioritization_score > 0) %>%
  mutate(
    sender = factor(sender, levels = senders_receivers),
    receiver = factor(receiver, levels = senders_receivers)
  ) %>%
  arrange(sender, receiver)

circos_list1 = make_circos_group_comparison(prioritized_tbl_bl, colors_sender, colors_receiver)
```

```{r fig.width=12, fig.height=15}
prioritized_tbl_t <- prioritized_tbl_oi %>%
  filter(group == 'CTB_T' & prioritization_score > 0) %>%
  mutate(
    sender = factor(sender, levels = senders_receivers),
    receiver = factor(receiver, levels = senders_receivers)
  ) %>%
  arrange(sender, receiver)

circos_list2 = make_circos_group_comparison(prioritized_tbl_t, colors_sender, colors_receiver)
```

```{r}
target_cells <- c("CCL19..FB", "Th17.Treg", "SPP1.Mac", "TREM2.Mac")
filtered_tbl <- prioritized_tbl_oi %>%
  filter(sender %in% target_cells | receiver %in% target_cells)

glimpse(filtered_tbl)
```

```{r}
target_cells <- c("CCL19..FB", "Th17.Treg", "SPP1.Mac", "TREM2.Mac")

filtered_tbl <- prioritized_tbl_oi %>%
  filter(group == 'CTB_BL' & 
         prioritization_score > 0 & 
         (sender %in% target_cells & receiver %in% target_cells))

glimpse(filtered_tbl)

prioritized_tbl_t <- filtered_tbl %>%
  mutate(
    sender = factor(sender, levels = senders_receivers),
    receiver = factor(receiver, levels = senders_receivers)
  ) %>%
  arrange(sender, receiver)

circos_list2 = make_circos_group_comparison(prioritized_tbl_t, colors_sender, colors_receiver)
```

```{r}
target_cells <- c("SPP1.Mac")

filtered_tbl <- prioritized_tbl_oi %>%
  filter(group == 'CTB_BL' & 
         prioritization_score > 0 & 
         (sender %in% target_cells ))

glimpse(filtered_tbl)

prioritized_tbl_t <- filtered_tbl %>%
  mutate(
    sender = factor(sender, levels = senders_receivers),
    receiver = factor(receiver, levels = senders_receivers)
  ) %>%
  arrange(sender, receiver)

circos_list2 = make_circos_group_comparison(prioritized_tbl_t, colors_sender, colors_receiver)
```

```{r}
target_cells <- c("SPP1.Mac")

filtered_tbl <- prioritized_tbl_oi %>%
  filter(group == 'CTB_BL' & 
         prioritization_score > 0 & 
         (receiver %in% target_cells ))

glimpse(filtered_tbl)

prioritized_tbl_t <- filtered_tbl %>%
  mutate(
    sender = factor(sender, levels = senders_receivers),
    receiver = factor(receiver, levels = senders_receivers)
  ) %>%
  arrange(sender, receiver)

circos_list2 = make_circos_group_comparison(prioritized_tbl_t, colors_sender, colors_receiver)
```

```{r include=FALSE}
circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver)
```

#### 6.1.2 **Interpretable bubble plots**

```{r}
prioritized_tbl_oi_M_30 = prioritized_tbl_oi_all %>%  filter(group == "CTB_T")
plot_oi = make_sample_lr_prod_activity_plots_Omnipath(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_30 %>% inner_join(lr_network_all)
)
plot_oi
```

```{r}
group_oi = "CTB_BL"
senders_oi = "Th17.Treg"
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 10,  
  groups_oi = group_oi, 
  senders_oi = senders_oi)
combined_plot = make_ligand_activity_target_plot(
  group_oi, 
  senders_oi, 
  prioritized_tbl_oi_M_10,
  multinichenet_output$prioritization_tables, 
  multinichenet_output$ligand_activities_targets_DEgenes, 
  contrast_tbl, 
  multinichenet_output$grouping_tbl, 
  multinichenet_output$celltype_info, 
  ligand_target_matrix, 
  plot_legend = FALSE)
combined_plot$combined_plot
```

```{r}
receiver_oi = "Th17.Treg"
senders_oi  = c("M1.like.Mac", "M2.like.Mac", "SPP1.Mac", "TREM2.Mac")

prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 10, 
  groups_oi = group_oi, 
  senders_oi = senders_oi,
  receivers_oi = receiver_oi)
combined_plot = make_ligand_activity_target_plot(
  group_oi, 
  receiver_oi, 
  prioritized_tbl_oi_M_10,
  multinichenet_output$prioritization_tables, 
  multinichenet_output$ligand_activities_targets_DEgenes, 
  contrast_tbl, 
  multinichenet_output$grouping_tbl, 
  multinichenet_output$celltype_info, 
  ligand_target_matrix, 
  plot_legend = FALSE)
combined_plot$combined_plot
```

```{r}
senders_oi = "Th17.Treg"
receiver_oi  = c("M1.like.Mac", "M2.like.Mac", "SPP1.Mac", "TREM2.Mac")

prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 10, 
  groups_oi = group_oi, 
  senders_oi = senders_oi,
  receivers_oi = receiver_oi)
combined_plot = make_ligand_activity_target_plot(
  group_oi, 
  receiver_oi, 
  prioritized_tbl_oi_M_10,
  multinichenet_output$prioritization_tables, 
  multinichenet_output$ligand_activities_targets_DEgenes, 
  contrast_tbl, 
  multinichenet_output$grouping_tbl, 
  multinichenet_output$celltype_info, 
  ligand_target_matrix, 
  plot_legend = FALSE)
combined_plot$combined_plot
```

```{r}
senders_oi = "Th17.Treg"
receiver_oi  = c("M1.like.Mac")

prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 10, 
  groups_oi = group_oi, 
  senders_oi = senders_oi,
  receivers_oi = receiver_oi)
combined_plot = make_ligand_activity_target_plot(
  group_oi, 
  receiver_oi, 
  prioritized_tbl_oi_M_10,
  multinichenet_output$prioritization_tables, 
  multinichenet_output$ligand_activities_targets_DEgenes, 
  contrast_tbl, 
  multinichenet_output$grouping_tbl, 
  multinichenet_output$celltype_info, 
  ligand_target_matrix, 
  plot_legend = FALSE)
combined_plot$combined_plot
```

```{r}
group_oi = "CTB_BL"
prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 10, 
  groups_oi = group_oi, 
  senders_oi = "Th17.Treg",
  receivers_oi = "CCL19..FB"
) 
plot_oi = make_sample_lr_prod_activity_plots_Omnipath(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50 %>% inner_join(lr_network_all)
)
plot_oi
```

```{r}
group_oi = "CTB_BL"
prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 10, 
  groups_oi = group_oi, 
  senders_oi = "Th17.Treg",
  receivers_oi = "SPP1.Mac",
) 
plot_oi = make_sample_lr_prod_activity_plots_Omnipath(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50 %>% inner_join(lr_network_all)
)
plot_oi
```

```{r}
group_oi = "CTB_BL"
prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 10, 
  groups_oi = group_oi, 
  receivers_oi = "Th17.Treg",
  senders_oi ="SPP1.Mac",
) 
plot_oi = make_sample_lr_prod_activity_plots_Omnipath(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50 %>% inner_join(lr_network_all)
)
plot_oi
```
